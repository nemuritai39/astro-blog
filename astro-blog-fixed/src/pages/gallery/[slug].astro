---
import BaseHead from "../../components/BaseHead.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";

/** ✅ glob：一次拿到所有 md（无需 getCollection） */
const modules = import.meta.glob("../../content/gallery/*.md", { eager: true }) as Record<string, any>;

/** ✅ 兼容 Windows/网页端路径：先统一成 / */
function normalize(p: string) {
  return p.replaceAll("\\", "/");
}

/** ✅ 从模块路径里取 slug：xxx/content/gallery/abc.md -> abc */
function slugFromPath(p: string) {
  const n = normalize(p);
  const file = n.split("/").pop() || "";
  return file.replace(/\.md$/, "");
}

/** ✅ Astro.params.slug 可能是 string | string[] */
function getSlugParam(v: unknown) {
  if (Array.isArray(v)) return v.join("/");
  if (typeof v === "string") return v;
  return "";
}

export async function getStaticPaths() {
  return Object.keys(modules).map((p) => ({
    params: { slug: slugFromPath(p) }, // ✅ 对应 [slug].astro：这里就是 string
  }));
}

const slug = getSlugParam(Astro.params.slug);

/** ✅ 找到对应 md 模块 */
const hitEntry = Object.entries(modules).find(([p]) => slugFromPath(p) === slug);
if (!hitEntry) throw new Error(`Gallery entry not found: ${slug}`);

const mod: any = hitEntry[1];
const fm = mod.frontmatter ?? {};
const Content = mod.default;

const pageTitle = `${fm.title ?? slug} · gallery · nemu · archive`;
const description = fm.note ?? "gallery item";
const cover = fm.cover ?? "";
const pubDate = fm.pubDate ? new Date(fm.pubDate) : null;
---

<html lang="en">
  <head>
    <BaseHead title={pageTitle} description={description} />
    <style>
      .wrap { max-width: 1100px; margin: 0 auto; padding: 68px 20px; }

      .back{
        display:inline-flex; align-items:center; gap:10px;
        text-decoration:none;
        padding:10px 14px; border-radius:999px;
        border:1px solid rgba(255,255,255,.12);
        background: rgba(255,255,255,.03);
        opacity:.9;
        transition: transform .15s ease, border-color .15s ease, opacity .15s ease;
      }
      .back:hover{ opacity:1; border-color: rgba(214,178,94,.55); transform: translateY(-1px); }
      .back::before{ content:"←"; opacity:.8; }

      .title{
        margin: 18px 0 8px;
        font-family: var(--font-display);
        letter-spacing: .06em;
        font-size: clamp(34px, 4.6vw, 52px);
        line-height: 1.06;
      }
      .meta{ opacity:.72; margin-bottom: 18px; }

      .frame{
        border-radius: 22px;
        background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
        border: 1px solid rgba(255,255,255,.14);
        box-shadow: 0 26px 60px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.06);
        overflow:hidden;
      }
      .frame img{
        width:100%;
        max-height: 76vh;
        object-fit: contain;
        display:block;
        background: rgba(0,0,0,.25);
      }

      .note{ margin-top: 14px; max-width: 70ch; opacity: .88; line-height: 1.9; }

      .md{
        margin-top: 18px;
        max-width: 76ch;
        opacity: .9;
      }
      .md :global(p){ line-height: 1.9; }
    </style>
  </head>

  <body>
    <Header />
    <main class="wrap">
      <a class="back" href="/gallery">Back to Gallery</a>

      <h1 class="title">{fm.title ?? slug}</h1>
      <div class="meta">
        {pubDate ? pubDate.toLocaleDateString("zh-CN") : ""}
      </div>

      {cover && (
        <div class="frame">
          <img src={cover} alt={fm.title ?? slug} loading="eager" />
        </div>
      )}

      {fm.note && <p class="note">{fm.note}</p>}

      <div class="md">
        <Content />
      </div>
    </main>
    <Footer />
  </body>
</html>
