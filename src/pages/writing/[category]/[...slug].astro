---
import { getCollection, render } from 'astro:content';
import BaseHead from '@/components/BaseHead.astro';
import Header from '@/components/Header.astro';
import Footer from '@/components/Footer.astro';

export async function getStaticPaths() {
	const categories = ['essays', 'thinking', 'poems', 'goals'] as const;
	const allPaths = await Promise.all(
		categories.map(async (cat) => {
			const posts = await getCollection(cat);
			return posts.map(post => {
				const cleanSlug = post.id.replace(/\.[^/.]+$/, ""); 
				return {
					params: { category: cat, slug: cleanSlug },
					props: { post },
				};
			});
		})
	);
	return allPaths.flat();
}

const { post } = Astro.props;
const { category } = Astro.params;
const { Content } = await render(post);

// 视觉主题：直接定义颜色，确保 CSS 变量能精准读取
const themes = {
	essays: { color: '#E2E2E2', name: '随笔' },
	poems: { color: '#C0C0C0', name: '诗歌' },
	thinking: { color: '#D4AF37', name: '思考' },
	goals: { color: '#B39DDB', name: '目标' },
};
const currentTheme = themes[category as keyof typeof themes] || themes.essays;
---

<html lang="en">
	<head>
		<BaseHead title={post.data.title} description={post.data.description} />
		<style define:vars={{ themeColor: currentTheme.color }}>
			/* 进度条保持 */
			#progress-bar { position: fixed; top: 0; left: 0; width: 0%; height: 2px; background: var(--themeColor); z-index: 10000; }

			main { max-width: 800px; margin: 0 auto; padding: 100px 24px; }

			/* 文章头部 */
			.article-header { text-align: center; margin-bottom: 5em; }
			.category-tag { font-family: 'Cinzel', serif; font-size: 0.7rem; letter-spacing: 0.5em; color: var(--themeColor); opacity: 0.5; display: block; margin-bottom: 1.5em; }
			.article-header h1 { font-family: 'Cinzel', serif; font-size: 2.2rem; color: #fff; font-weight: 400; }

			/* --- 正文核心排版 --- */
			.prose { 
				font-family: 'EB Garamond', 'Noto Serif SC', serif; 
				font-size: 1.2rem; line-height: 2; 
				color: rgba(255, 255, 255, 0.8); 
			}

			/* 1. 修复引文：恢复那种带颜色的独特字体感 */
			.prose :global(blockquote) {
				margin: 5em auto;
				padding: 2em 0;
				border-top: 1px solid rgba(255, 255, 255, 0.08);
				border-bottom: 1px solid rgba(255, 255, 255, 0.08);
				text-align: center;
				font-style: italic;
				/* 核心颜色修复 */
				color: var(--themeColor); 
				font-family: 'Cormorant Garamond', serif;
				opacity: 0.9;
			}
			.prose :global(blockquote p) { font-size: 1.3rem; letter-spacing: 0.05em; }

			/* 2. 修复诗歌：改回全居中排版 */
			.is-poems { 
				text-align: center; 
			}
			.is-poems :global(p) { 
				margin-bottom: 1.8rem; 
				letter-spacing: 0.15em;
				/* 确保诗歌行间距足够优雅 */
			}
			.is-poems :global(p:empty) { height: 2.5em; }

			/* 3. 修复随笔：首字下沉颜色 */
			.prose:not(.is-poems) :global(p:first-of-type::first-letter) {
				font-family: 'Cinzel', serif;
				font-size: 3.5rem;
				float: left;
				line-height: 1;
				padding-right: 12px;
				color: var(--themeColor);
			}

			.post-footer { margin-top: 8em; padding-top: 2em; border-top: 1px solid rgba(255, 255, 255, 0.05); text-align: center; }
			.back-link { font-family: 'Cinzel', serif; font-size: 0.8rem; color: rgba(255, 255, 255, 0.3); text-decoration: none; letter-spacing: 0.2em; }
			.back-link:hover { color: var(--themeColor); }
		</style>
	</head>
	<body>
		<div id="progress-bar"></div>
		<Header />
		<main>
			<article>
				<header class="article-header">
					<span class="category-tag">// {currentTheme.name}</span>
					<h1>{post.data.title}</h1>
				</header>
				<div class={`prose ${category === 'poems' ? 'is-poems' : ''}`}>
					<Content />
				</div>
			</article>
			<footer class="post-footer">
				<a href={`/writing/${category}`} class="back-link">← BACK TO {currentTheme.name}</a>
			</footer>
		</main>
		<script>
			window.onscroll = () => {
				const bar = document.getElementById("progress-bar");
				if (bar) {
					const winScroll = document.documentElement.scrollTop;
					const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
					bar.style.width = (winScroll / height * 100) + "%";
				}
			};
		</script>
		<Footer />
	</body>
</html>
